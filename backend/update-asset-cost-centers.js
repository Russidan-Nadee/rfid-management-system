const { PrismaClient } = require('@prisma/client');
const fs = require('fs');
const prisma = new PrismaClient();

// à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œ txt à¸—à¸µà¹ˆà¸„à¸¸à¸“à¹ƒà¸«à¹‰à¸¡à¸²
const ASSET_COST_CENTER_DATA = `C57385	903100
C58422	200200
C58423	200200
C58392
C58430	110100
C58437	110100
C59457
C59470
C59454
C60490	214000
C60491
C60494
C60512
C60511
C60517	231000
C60520	235000
C60497
C60498
NB60142	200200
C60522	230200
NB60153	200200
NB60155	200200
C60486	230200
NB60156
C61531
C61534
C61530
C61532
C61533
C61536
NB61178
C61541	903100
C61584	221000
C61555	110100
C61546
C61571
C61554
C61573	230300
C61579
C61581
C61551	200200
C61553
C61580	230200
C61549	211000
C61552	213000
C61566
C61577
C61575
C61544
C61545
C61543
C61570
C61569	903100
C61594
NB61183
C61592	200500
C61589
C61588	200200
C61558	110100
C61561	200200
C61562	200200
C61563
C61567
C61564
C61568
C61585	200200
C61574
C61527	299210
C61557
C61587	110100
C61550
C61578
NB62184
NB62187
NB62188	110100
NB62191	903100
NB62190
C62599
C62598
C62597
C62600	903300
C62601	905100
C62602	905100
NB62193
C62605	299130
NB62195
C62613
C62614	299220
C62608	230200
C62610	230100
C62609	236000
C62617	199220
C62618	230100
C62620
NB62198
C62622
NB62194
NB62225
NB63201	902100
NB63214	200500
NB63223	230100
NB63225
NB63207
NB63226	902100
NB63204
NB63228	299130
NB63202
NB63206	905100
NB63209	234000
NB63212
NB63234	905200
NB63235	231000
NB63249	199220
NB63239	901300
NB63240	110110
NB63243
NB63244
NB63246	904200
NB63245	221000
NB63250	199220
NB63255	903100
NB63252	299220
NB63251	199220
NB63253	901100
NB63256	901200
NB63257	299210
NB63258	200410
C63624
NB63261	903100
NB63259	903100
NB63266	901300
NB63264	904100
NB63262	200410
NB63263	903100
NB63267	904200
NB63268
NB63271	299210
NB63272	110100
NB63270	200410
NB63222	110120
NB63269
NB63230	231000
C63623	230200
NB63219
NB63221
NB63218
NB63210	903100
NB63216
NB63248
NB64275	903100
NB64287	905100
NB64277	905100
NB64273	905100
NB64278	110100
NB64276	905100
NB64283	199100
NB64280	110100
NB64282
NB64284	110100
NB64286	110100
NB64285	110100
NB64289	230100
NB64292	230100
NB64291
NB64294	199220
NB64288	903100
NB64307	903100
NB64300	110100
NB64301	903100
NB64305	903100
NB64303	903100
NB64304	901500
NB64302	904200
NB64299
NB64298	230300
NB64296
NB64297	236000
NB64309	200200
NB64312	199210
NB64311	903100
NB64316	199210
NB64319	199210
NB64313	903100
NB64315	199210
NB64318	199210
NB64331	200410
NB64322
NB64327	200300
NB64326	200410
NB64320	199210
NB64321	199210
NB64329	299110
NB64328	211000
NB64330	200410
NB64323	199220
NB64324	199220
NB64325	199220
NB64310	903300
NB64333	902100
NB64332	902200
NB64334	902100
NB64335	902100
NB64336	901500
NB64337	901500
NB64240	199220
NB64339	199220
NB64338	199220
NB64343	903100
NB64342	299220
NB64370	230300
NB64372	200500
NB64375	211000
NB64371	234000
NB64373	200200
NB64374	200200
NB64344
NB64351	902100
NB64349	902100
NB64350	902100
NB64379	200500
NB64378	200100
NB64377
NB64376	214000
NB64352	299210
NB64353	299210
NB64354	200300
NB64355	200200
NB64356	221000
NB64357	230100
NB64358	230100
NB64362	230100
NB64363	230200
NB64361	236000
NB64360	236000
NB64359	200500
NB64364	200500
NB64345
NB64347	905100
NB64348	905100
NB64346	903100
NB64365	231000
NB64367	231000
NB64366	235000
NB64368
NB64369	234000
NB64385	902200
NB64381	199220
NB64384	199220
NB64382	199220
NB64386	905200
NB64388
NB64389	200500
NB64390	200200
NB64383	199220
NB64387
NB65394	199210
NB65395	199210
NB65392	199210
NB65400
NB65397
NB65396	199210
NB65393	199210
NB65398	902200
NB65401	199220
NB65402	199220
NB65403	199220
NB65404	199220
NB65391	901100
NB65405	199220
NB65406	905100
NB65408	903100
NB65409	903100
NB65410	903100
NB65407	904100
NB65417	200200
NB65418
NB65411	903100
NB65412	901400
NB65413	110100
NB65415	901300
NB65416	199210
NB65420	903100
NB65421	901500
NB65414	230200
NB65430	904200
NB65429	903100
NB65431	199100
NB65432	110100
NB65433	110100
NB65434	110100
NB65435	200500
NB65436	211000
NB65425	904100
NB65428	200300
NB65426	901500
C65630	901300
C65631	901300
NB65427	299220
NB65422	237000
C65628	901300
C65629	901300
NB65437	110100
C65632
C65633
C65634
NB65438	902200
NB65439	902200
NB65440
NB65441	236000
NB65442	901200
NB65443	299110
NB65444	299110
NB65445	299110
NB65446	299120
NB65447	214000
NB65449	213000
NB65450	299210
NB65448	905100
NB65451	903100
NB65452	110100
C65636	214000
C65637	200200
C65635
NB65453	903100
NB65454	905100
C65639
C65638
C65640	299130
NB65455	200410
NB65457	901100
NB65456	901100
NB65419	299210
NB65424	199210
NB65423	237000
NB65399	903100
NB66458	904200
NB66459	904200
NB66500	230100
NB66471	903100
NB66474	903100
NB66465	902100
NB66466	902100
NB66467	214000
NB66461
NB66468
NB66477	901200
NB66484	905100
NB66505	299110
NB66483	299210
NB66481	199210
NB66509	221000
NB66485	902100
NB66482	211000
NB66469	903100
NB66512	903100
NB66511	904100
NB66462	903100
NB66460	903100
NB66472	903100
NB66470	903100
NB66473	903100
NB66475	903100
NB66486	110100
NB66508	200500
NB66476	903100
NB66490	903300
NB66487	905100
NB66506	221000
NB66507	299120
NB66504	221000
NB66503	200500
NB66501	230100
NB66492	903300
NB66478	211000
NB66479	905100
NB66480	200300
NB66488	110100
C66643	901400
NB66497	299220
NB66498	299220
C66641	214000
C66642
C66644	199100
C66645
C66659	299120
NB66502	230300
NB66489	237000
NB66463	903100
NB66495	903300
NB66494	903300
NB66499	230100
NB66491	903300
NB66496	199220
NB66493	903300
NB66510	200500
NB66514	230200
NB66464	903100
C66650	299130
C66651
C66652	299130
C66649	299130
C66653	299130
NB66515	299210
C66656
C66654	234000
C66657	230200
C66658
C66647	299130
C66648	299130
C66646	230300
C66655	230200
NB66513	299210
NB66521	904200
NB66517	904100
NB66519	904200
NB66522	904200
NB66516	904100
NB66518	904100
NB66520	904200
C66661	901400
C66660	901400
NB67524	903100
NB67523	903100
NB67540	299210
NB67534	200410
NB67526	903100
NB67525	905200
NB67527	200100
NB67538	200100
NB67539	199210
NB67531	299220
NB67532	299220
NB67541
NB67533	299220
NB67530
NB67528
NB67535	901500
NB67537	299210
NB67542	903100
NB67529	110100
NB67544	904100
NB67543	903100
C67660
C67664	230300
C67665	230300
C67662	903100
C67661
C67671	230200
C67666	903100
C67670
NB67536	299210
C67669	299210
C67667	230300
NB67546	901200
C67681
NB67547	904200
NB67548	901200
NB67545	903100
NB67549	200410
CL68683	 `;

function parseAssetData(data) {
  const lines = data.trim().split('\n');
  const mapping = {};

  for (const line of lines) {
    const [assetNo, costCenter] = line.split('\t');
    if (assetNo) {
      mapping[assetNo] = costCenter && costCenter.trim() ? costCenter.trim() : null;
    }
  }

  return mapping;
}

async function updateAssetCostCenters() {
  console.log('ðŸ”„ Starting asset cost center update...');
  await prisma.$connect();

  try {
    const MAPPING = parseAssetData(ASSET_COST_CENTER_DATA);
    console.log(`ðŸ“Š Found ${Object.keys(MAPPING).length} assets in mapping`);

    let updated = 0;
    let skipped = 0;

    // à¸­à¸±à¸›à¹€à¸”à¸•à¸—à¸µà¸¥à¸°à¸•à¸±à¸§
    for (const [assetNo, costCenterCode] of Object.entries(MAPPING)) {
      try {
        const result = await prisma.asset_master.updateMany({
          where: { asset_no: assetNo },
          data: { cost_center_code: costCenterCode }
        });

        if (result.count > 0) {
          updated++;
          const status = costCenterCode ? `â†’ ${costCenterCode}` : 'â†’ null';
          console.log(`âœ… Updated ${assetNo} ${status}`);
        } else {
          skipped++;
          console.log(`â­ï¸  Skip ${assetNo} (not found in database)`);
        }
      } catch (error) {
        console.error(`âŒ Failed to update ${assetNo}:`, error.message);
      }
    }

    console.log(`\nðŸ“Š Update Summary: ${updated} updated, ${skipped} skipped`);

    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ
    const assetsWithCostCenter = await prisma.asset_master.count({
      where: { cost_center_code: { not: null } }
    });

    const totalAssets = await prisma.asset_master.count();

    console.log(`\nðŸ“ˆ Final Result:`);
    console.log(`   âœ… Assets with Cost Center: ${assetsWithCostCenter}/${totalAssets} (${((assetsWithCostCenter/totalAssets)*100).toFixed(1)}%)`);

  } catch (error) {
    console.error('âŒ Error during update:', error.message);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

updateAssetCostCenters()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  });